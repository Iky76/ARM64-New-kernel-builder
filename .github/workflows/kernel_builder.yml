name: ğŸŒŸ Kernel Build

on:
  workflow_dispatch:
    inputs:
      kernel_source:
        description: 'ğŸŒ Kernel source repo'
        required: true
        default: 'https://github.com/lynxprjkt/android_kernel_xiaomi_begonia'
      kernel_branch:
        description: 'ğŸŒ¿ Branch kernel'
        required: true
        default: 'main'
      defconfig_name:
        description: 'âš™ï¸ Defconfig (e.g. begonia_user_defconfig)'
        required: true
        default: 'begonia_user_defconfig'
      use_anykernel:
        description: 'ğŸ“¦ Use AnyKernel packaging? (yes / no)'
        required: true
        default: 'yes'
      anykernel_source:
        description: 'ğŸ”— AnyKernel source repo'
        required: false
        default: 'https://github.com/lynxprjkt/AnyKernel3'
      anykernel_branch:
        description: 'ğŸ§µ AnyKernel branch'
        required: false
        default: 'main'
      username:
        description: 'ğŸ‘¤ Builder username'
        required: true
        default: 'lynx'
      workspace_name:
        description: 'ğŸ“ Workspace name'
        required: true
        default: 'lynxworkspace'
      telegram_token:
        description: 'ğŸ” Telegram bot token'
        required: false
      telegram_chat_id:
        description: 'ğŸ’¬ Telegram chat ID'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      BUILD_USER: ${{ github.event.inputs.username }}
      BUILD_HOST: ${{ github.event.inputs.workspace_name }}
      DEVICE_NAME: ${{ github.event.inputs.defconfig_name }}
      START_TIME: ${{ github.event.created_at }}

    steps:
      - name: ğŸ“¨ Notify Telegram (Start)
        if: ${{ github.event.inputs.telegram_token != '' && github.event.inputs.telegram_chat_id != '' }}
        run: |
          DEVICE=$(echo "${DEVICE_NAME}" | sed 's/_defconfig//')
          TIME=$(date +"%Y-%m-%d %H:%M:%S" -d "${{ github.event.created_at }}")
          curl -s -X POST https://api.telegram.org/bot${{ github.event.inputs.telegram_token }}/sendMessage \
            -d chat_id=${{ github.event.inputs.telegram_chat_id }} \
            -d text="âŒ› *Kernel Build Started*\n\nğŸ“± *Device* : ${DEVICE}\nâ±ï¸ *Triggered Time* : ${TIME}\nâš™ï¸ *Builder Name* : ${{ github.event.inputs.username }}" \
            -d parse_mode=Markdown \
            -d reply_markup='{"inline_keyboard":[[{"text":"See Progress On Github","url":"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}]]}'

      - name: ğŸ“¥ Checkout Repo
        uses: actions/checkout@v4

      - name: âš™ï¸ Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential bc libncurses-dev bison flex libssl-dev libelf-dev curl wget zip git

      - name: ğŸŒ€ Pull Lineage Clang
        run: |
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 aarch64-linux-android-4.9
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 arm-linux-androideabi-4.9
          mkdir clang
          curl https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android14-dev/clang-r487747c.tar.gz -RLO
          tar -C clang/ -xf clang-*.tar.gz

      - name: ğŸŒ¿ Clone Kernel Source
        run: |
          git clone --depth=1 ${{ github.event.inputs.kernel_source }} -b ${{ github.event.inputs.kernel_branch }} ${{ github.event.inputs.workspace_name }}

      - name: ğŸ”¨ Build Kernel
        run: |
          export ARCH=arm64
          export SUBARCH=arm64
          export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
          export CROSS_COMPILE=$GITHUB_WORKSPACE/aarch64-linux-android-4.9/bin/aarch64-linux-android-
          export CROSS_COMPILE_ARM32=$GITHUB_WORKSPACE/arm-linux-androideabi-4.9/bin/arm-linux-androideabi-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export KBUILD_BUILD_USER=${{ env.BUILD_USER }}
          export KBUILD_BUILD_HOST=${{ env.BUILD_HOST }}
          cd ${{ github.event.inputs.workspace_name }}
          make O=out ${{ github.event.inputs.defconfig_name }}
          make -j$(nproc) O=out

      - name: ğŸ“¦ Package Kernel (AnyKernel)
        if: ${{ github.event.inputs.use_anykernel == 'yes' }}
        run: |
          git clone --depth=1 ${{ github.event.inputs.anykernel_source }} -b ${{ github.event.inputs.anykernel_branch }} AnyKernel3
          rm -rf AnyKernel3/.git AnyKernel3/.github AnyKernel3/LICENSE AnyKernel3/README.md
          IMAGE_PATH=""
          for file in Image.gz-dtb Image-dtb Image.gz Image; do
            if [[ -f out/arch/arm64/boot/$file ]]; then
              cp out/arch/arm64/boot/$file AnyKernel3/$file
              IMAGE_PATH="AnyKernel3/$file"
              break
            fi
          done
          if [[ -f out/arch/arm64/boot/dtbo.img ]]; then
            cp out/arch/arm64/boot/dtbo.img AnyKernel3/dtbo.img
          fi
          cd AnyKernel3
          ZIP_NAME="kernel-${{ github.event.inputs.username }}-$(date +%Y%m%d-%H%M).zip"
          zip -r9 "$ZIP_NAME" * -x "*.git*" "*.md" "LICENSE" ".github/*"

      - name: ğŸ“¤ Upload Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Flashable-Kernel
          path: AnyKernel3/kernel-${{ github.event.inputs.username }}-*.zip

      - name: âœ… Telegram Notification (Success)
        if: success() && github.event.inputs.telegram_token != '' && github.event.inputs.telegram_chat_id != ''
        run: |
          DEVICE=$(echo "${DEVICE_NAME}" | sed 's/_defconfig//')
          curl -s -X POST https://api.telegram.org/bot${{ github.event.inputs.telegram_token }}/sendMessage \
            -d chat_id=${{ github.event.inputs.telegram_chat_id }} \
            -d text="âœ… *Build Success*\n\nğŸ“± *Device* : ${DEVICE}\nâ±ï¸ *Time* : $(date +"%Y-%m-%d %H:%M:%S")\nâš™ï¸ *Builder Name* : ${{ github.event.inputs.username }}" \
            -d parse_mode=Markdown \
            -d reply_markup='{"inline_keyboard":[[{"text":"Download Output","url":"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}]]}'

      - name: âŒ Telegram Notification (Failed)
        if: failure() && github.event.inputs.telegram_token != '' && github.event.inputs.telegram_chat_id != ''
        run: |
          DEVICE=$(echo "${DEVICE_NAME}" | sed 's/_defconfig//')
          curl -s -X POST https://api.telegram.org/bot${{ github.event.inputs.telegram_token }}/sendMessage \
            -d chat_id=${{ github.event.inputs.telegram_chat_id }} \
            -d text="âŒ *Build Failed*\n\nğŸ“± *Device* : ${DEVICE}\nâ±ï¸ *Time* : $(date +"%Y-%m-%d %H:%M:%S")\nâš™ï¸ *Builder Name* : ${{ github.event.inputs.username }}" \
            -d parse_mode=Markdown \
            -d reply_markup='{"inline_keyboard":[[{"text":"See Logs on Github","url":"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}]]}'
